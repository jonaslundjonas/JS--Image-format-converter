<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Format Converter</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Material Symbols font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- 3. Load tiff.js for TIFF *input* support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tiff.js/1.0.0/tiff.min.js"></script>
    <!-- 4. Load UTIF.js for TIFF *output* support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/utif/3.1.0/UTIF.js"></script>
    
    <!-- 5. Configure Tailwind for Inter font and dark mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        // Material 3 Dark Theme color palette (approx.)
                        primary: '#A8C7FA', // Primary (e.g., buttons)
                        onPrimary: '#003062',
                        primaryContainer: '#004788',
                        onPrimaryContainer: '#D6E3FF',
                        secondary: '#BEC6DC', // Secondary actions
                        onSecondary: '#283141',
                        secondaryContainer: '#3E4759',
                        onSecondaryContainer: '#DAE2F9',
                        tertiary: '#DEBCDF', // Accent
                        onTertiary: '#402843',
                        tertiaryContainer: '#583E5B',
                        onTertiaryContainer: '#FAD8FC',
                        error: '#F2B8B5',
                        onError: '#601410',
                        errorContainer: '#8C1D18',
                        onErrorContainer: '#F9DEDC',
                        background: '#111318', // Page background
                        onBackground: '#E3E2E6', // Default text
                        surface: '#111318', // Card background
                        onSurface: '#E3E2E6', // Card text
                        surfaceVariant: '#44474E', // Outlines, dividers, input backgrounds
                        onSurfaceVariant: '#C4C6CF', // Medium-emphasis text
                        outline: '#8E9099',
                    }
                }
            }
        }
    </script>
    <!-- 6. Custom styles for Material Symbols -->
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
            vertical-align: bottom; /* Aligns icons nicely with text */
        }
    </style>
</head>
<body class="bg-background font-sans text-onBackground min-h-screen flex items-center justify-center p-4">

    <!-- Main Converter Card -->
    <div class="w-full max-w-md bg-surface rounded-3xl shadow-2xl overflow-hidden" style="background-color: #1A1C20;"> <!-- Slightly lighter surface -->
        
        <!-- Header -->
        <div class="p-6 border-b border-surfaceVariant">
            <h1 class="text-2xl font-medium text-center text-onSurface">Image Converter</h1>
            <p class="text-sm text-center text-onSurfaceVariant mt-1">Convert JPEG, PNG, WebP, SVG, and TIFF files.</p>
        </div>

        <!-- Main Content Area -->
        <div class="p-6 flex flex-col gap-6">

            <!-- 1. File Upload Area -->
            <div>
                <label for="file-upload" class="flex flex-col items-center justify-center w-full h-32 border-2 border-surfaceVariant border-dashed rounded-2xl cursor-pointer bg-background hover:bg-surfaceVariant/20 transition-colors">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <span class="material-symbols-outlined text-4xl text-onSurfaceVariant">upload_file</span>
                        <p class="mb-2 text-sm text-onSurfaceVariant"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                        <p class="text-xs text-onSurfaceVariant">PNG, JPG, WebP, SVG, or TIFF</p>
                    </div>
                    <!-- Updated accept attribute -->
                    <input id="file-upload" type="file" class="hidden" accept="image/jpeg,image/png,image/webp,image/svg+xml,image/tiff">
                </label>
            </div>

            <!-- 2. Image Preview -->
            <div id="preview-container" class="hidden relative w-full aspect-video bg-background rounded-2xl overflow-hidden ring-1 ring-surfaceVariant">
                <img id="image-preview" src="#" alt="Image Preview" class="object-contain w-full h-full">
                <p id="image-info" class="absolute bottom-2 left-1/2 -translate-x-1/2 bg-black/50 text-white text-xs px-2 py-1 rounded-full backdrop-blur-sm"></p>
            </div>

            <!-- 3. Format Selector -->
            <div>
                <label for="format-select" class="block mb-2 text-sm font-medium text-onSurfaceVariant">Convert to:</label>
                <div class="relative">
                    <select id="format-select" class="block w-full px-4 py-3 text-base text-onSurface bg-surfaceVariant/50 border border-surfaceVariant rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition-all">
                        <option value="image/png">PNG (Lossless)</option>
                        <option value="image/jpeg">JPEG (100% Quality)</option>
                        <option value="image/webp">WebP (Lossless)</option>
                        <option value="image/tiff">TIFF (Lossless)</option>
                    </select>
                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-onSurfaceVariant pointer-events-none">
                        expand_more
                    </span>
                </div>
            </div>

            <!-- 4. Action Buttons -->
            <div class="flex flex-col gap-4">
                <!-- Status Message -->
                <p id="status-message" class="text-sm text-center text-secondary h-5"></p>

                <!-- Convert Button -->
                <button id="convert-btn" class="w-full flex items-center justify-center gap-2 bg-primary text-onPrimary font-medium py-3 px-5 rounded-full shadow-lg hover:shadow-primary/30 focus:outline-none focus:ring-4 focus:ring-primary/50 transition-all disabled:opacity-50 disabled:shadow-none" disabled>
                    <span class="material-symbols-outlined">sync</span>
                    Convert
                </button>
                
                <!-- Download Link (styled as a button) -->
                <a id="download-link" class="hidden w-full flex items-center justify-center gap-2 bg-tertiaryContainer text-onTertiaryContainer font-medium py-3 px-5 rounded-full shadow-lg hover:shadow-tertiary/30 focus:outline-none focus:ring-4 focus:ring-tertiary/50 transition-all">
                    <span class="material-symbols-outlined">download</span>
                    Download File
                </a>
            </div>

            <!-- 5. Footer Attribution -->
            <p class="text-xs text-center text-onSurfaceVariant/50 pt-4">
                Written by Jonas Lund 2025
            </p>

        </div>
    </div>

    <script>
        // Get DOM elements
        const fileInput = document.getElementById('file-upload');
        const previewContainer = document.getElementById('preview-container');
        const imagePreview = document.getElementById('image-preview');
        const imageInfo = document.getElementById('image-info');
        const formatSelect = document.getElementById('format-select');
        const convertBtn = document.getElementById('convert-btn');
        const downloadLink = document.getElementById('download-link');
        const statusMessage = document.getElementById('status-message');

        // Store the loaded image object (can be an Image or a Canvas)
        let originalImage = null;
        let originalFileName = '';
        let originalType = '';
        let currentBlobUrl = null; // To store blob URLs for revocation
        
        // Allowed input types
        const SUPPORTED_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml', 'image/tiff'];

        // --- Helper to revoke old blob URLs ---
        function revokeBlobUrl() {
            if (currentBlobUrl) {
                URL.revokeObjectURL(currentBlobUrl);
                currentBlobUrl = null;
            }
        }

        // --- Event Listener for File Input ---
        fileInput.addEventListener('change', (e) => {
            revokeBlobUrl(); // Clean up any previous blob URL
            const file = e.target.files[0];
            if (!file) {
                return;
            }

            // Check if the file type is supported
            if (!SUPPORTED_TYPES.includes(file.type)) {
                statusMessage.textContent = 'Error: Unsupported file type.';
                resetUI();
                return;
            }

            originalFileName = file.name.split('.').slice(0, -1).join('.');
            originalType = file.type;
            const reader = new FileReader();

            // Handle TIFF files separately
            if (file.type === 'image/tiff') {
                reader.onload = (event) => handleTiffFile(event.target.result);
                reader.readAsArrayBuffer(file);
            } 
            // Handle standard browser-supported types
            else {
                reader.onload = (event) => handleStandardImageFile(event.target.result);
                reader.readAsDataURL(file);
            }
            
            reader.onerror = () => {
                statusMessage.textContent = 'Error: Could not read file.';
                resetUI();
            };
        });

        // --- Handler for TIFF Files ---
        function handleTiffFile(arrayBuffer) {
            // Initialize tiff.js
            try {
                Tiff.initialize({ TOTAL_MEMORY: 16777216 * 10 }); // ~160MB
                const tiff = new Tiff(arrayBuffer);
                originalImage = tiff.toCanvas(); // This is an HTMLCanvasElement

                if (!originalImage) {
                    throw new Error('TIFF data could not be parsed.');
                }
                
                updatePreviewAndUI();

            } catch (error) {
                console.error('TIFF parsing error:', error);
                statusMessage.textContent = 'Error: Failed to load TIFF file.';
                resetUI();
            }
        }
        
        // --- Handler for Standard Image Files (JPG, PNG, WebP, SVG) ---
        function handleStandardImageFile(dataUrl) {
            originalImage = new Image(); // This is an HTMLImageElement
            
            originalImage.onload = () => {
                updatePreviewAndUI();
            };
            
            originalImage.onerror = () => {
                statusMessage.textContent = 'Error: Could not load image file.';
                resetUI();
            };

            originalImage.src = dataUrl;
        }

        // --- Common function to update UI after any image is loaded ---
        function updatePreviewAndUI() {
            const width = originalImage.width;
            const height = originalImage.height;

            // For TIFF, the originalImage is a canvas. We need to create a
            // Data URL from it for the <img> preview tag.
            if (originalType === 'image/tiff') {
                imagePreview.src = originalImage.toDataURL('image/png');
            }
            // For others, originalImage is an Image, and its .src is the Data URL.
            else {
                imagePreview.src = originalImage.src;
            }
            
            // Show preview
            previewContainer.classList.remove('hidden');
            
            // Show image info
            imageInfo.textContent = `Original: ${width}x${height} (${originalType.split('/')[1].toUpperCase()})`;
            
            // Enable conversion
            convertBtn.disabled = false;
            statusMessage.textContent = 'Ready to convert.';
            downloadLink.classList.add('hidden');
        }

        // --- Event Listener for Convert Button ---
        convertBtn.addEventListener('click', () => {
            if (!originalImage) {
                statusMessage.textContent = 'Please select an image first.';
                return;
            }

            statusMessage.textContent = 'Converting...';
            downloadLink.classList.add('hidden');
            convertBtn.disabled = true;

            // Use a timeout to allow the UI to update
            setTimeout(() => {
                try {
                    revokeBlobUrl(); // Clean up any previous blob URL

                    const targetFormat = formatSelect.value; // e.g., 'image/png'
                    const quality = 1.0; // 100% quality

                    // Create a canvas
                    const canvas = document.createElement('canvas');
                    canvas.width = originalImage.width;
                    canvas.height = originalImage.height;
                    const ctx = canvas.getContext('2d');

                    // Draw the image onto the canvas
                    // ctx.drawImage works with both HTMLImageElement and HTMLCanvasElement
                    ctx.drawImage(originalImage, 0, 0);

                    let convertedDataUrl;
                    let extension = targetFormat.split('/')[1]; // 'png', 'jpeg', 'webp', 'tiff'

                    if (targetFormat === 'image/tiff') {
                        // --- Handle TIFF Output ---
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        // UTIF.encodeImage expects the underlying ArrayBuffer of the RGBA data
                        const tiffBuffer = UTIF.encodeImage(imageData.data.buffer, canvas.width, canvas.height);
                        const blob = new Blob([tiffBuffer], { type: 'image/tiff' });
                        convertedDataUrl = URL.createObjectURL(blob);
                        currentBlobUrl = convertedDataUrl; // Store for later revocation
                    } else {
                        // --- Handle PNG, JPEG, WebP Output ---
                        convertedDataUrl = canvas.toDataURL(targetFormat, quality);
                    }

                    const newFileName = `${originalFileName}-converted.${extension}`;

                    // Set up the download link
                    downloadLink.href = convertedDataUrl;
                    downloadLink.download = newFileName;
                    downloadLink.classList.remove('hidden');
                    statusMessage.textContent = 'Conversion complete!';

                } catch (error) {
                    console.error('Conversion failed:', error);
                    statusMessage.textContent = 'Error: Conversion failed.';
                } finally {
                    // Re-enable the convert button
                    convertBtn.disabled = false;
                }
            }, 50); // 50ms delay
        });

        // --- Event Listener for Format Selector ---
        formatSelect.addEventListener('change', () => {
            // If format changes, hide the old download link
            downloadLink.classList.add('hidden');
            if (originalImage) {
                statusMessage.textContent = 'Ready to convert.';
            }
        });

        // --- Helper Function to Reset UI ---
        function resetUI() {
            revokeBlobUrl(); // Clean up any blob URL
            previewContainer.classList.add('hidden');
            imagePreview.src = '#';
            imageInfo.textContent = '';
            convertBtn.disabled = true;
            downloadLink.classList.add('hidden');
            originalImage = null;
            originalFileName = '';
            originalType = '';
            fileInput.value = null; // Clear the file input
        }

    </script>
</body>
</html>
